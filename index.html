<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="zesty.png" type="image/x-icon" rel="icon">
    <link rel="apple-touch-icon" href="zesty.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <title>Spotify Modded</title>
    <style>
        @font-face {
            font-family: 'CustomFont';
            src: url('font.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'CustomFont', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #ffffff;
        }

        #home, #searchcontent {
            padding: 20px;
        }

        #home h1 {
            margin-top: 0;
        }

        .playlisti {
            height: 50px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .playlisti h4, .songsearch h3 {
            margin-top: 0;
        }

        #player {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #000000;
            color: #fff;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
        }

        #player img {
            width: 80px;
            height: auto;
            margin-right: 15px;
        }

        #player b, #player p {
            margin: 0 15px;
            color: #f1f1f1;
        }

        #player audio {
            margin-left: 15px;
        }

        #playlist {
            display: flex;
            flex-direction: column;
        }

        .playlisti {
            display: flex;
            justify-content: space-between;
            border-radius: 5px;
            padding: 10px;
        }

        .playlisti:hover {
            background-color: #1f1f1f;
        }

        .playbtn {
            position: absolute;
            width: 20px !important;
            filter: invert(1) sepia(1) saturate(5) hue-rotate(180deg);
            display: none;
        }

        .playlisti:hover .playbtn {
            display: block;
        }


        #playlist button {
            margin-left: auto;
        }

        #loading {
            align-items: center;
            text-align: center;
            position: fixed;
            z-index: 1000;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            justify-content: center;
        }

        .crop-container {
            width: 50px;
            height: 50px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
        }

        .crop-container img {
            width: 180%;
            object-fit: cover;
        }

        .listi {
            position: absolute;
            left: 90px;
        }

        .listi h6 {
            color: #b3b3b3;
        }

        .removefromplaylist {
            background-color: rgba(0, 0, 0, 0);
        }

        button {
            border: none;
            background: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
        }

        .material-icons {
            color: #ffffff;
        }

        #leftcont button {
            padding: 15px 20px;
        }

        #rappername {
            color: #b3b3b3;
        }
    </style>
</head>
    <div id="leftcont">
        <button id="homeb"><i class="material-icons">home</i></button>
        <button id="searchb"><i class="material-icons">search</i></button>
    </div>
    <div id="main">
        <div id="home">
            <div id="playlist">
            </div>
            <p>Spotfy Modded 2024</p>
        </div>
        <div id="searchcontent" style="display: none;">
        </div>
    </div>

    <div id="player">
        <div class="crop-container">
            <img id="fgersi0sefdjhi" width="100px" src="">
        </div>
        <div>
            <b id="songname">Loading...</b>
            <p id="rappername">Loading...</p>
        </div>
            <button onclick="previousSong()"><i class="material-icons">skip_previous</i></button>
            <audio id="audioPlayer" controls>
                <source id="audioSource" src="" type="audio/mpeg">
            </audio>
            <button onclick="nextSong()"><i class="material-icons">skip_next</i></button>

    </div>
    <div id="loading" style="display: none;">
        <p id="nmaefjeaf">-</p>
        <progress value="0.5" id="diddy"></progress>
        <p id="progt">0% 0/1000</p>
    </div>

<script>
    let loadingsomething = false
    function loading(isloading, onnumber, maxnumber, name) {
        if (!isloading) {
            document.getElementById("loading").style.display = "none"
            loadingsomething= false
        } else {
            loadingsomething = true
            document.getElementById("nmaefjeaf").textContent = name
            if (onnumber) {
                document.getElementById("loading").style.display = ""
                const sigmagyat = `${((onnumber / maxnumber) * 100).toFixed(2)}%`
                document.getElementById("progt").textContent = sigmagyat
                document.getElementById("diddy").value = (onnumber / maxnumber).toString()
            } else {
                document.getElementById("loading").style.display = ""
                document.getElementById("progt").textContent = `Loading...`
                document.getElementById("diddy").value = "0"
            }

        }
    }

    let currentXhr = null;

    function fetchWithProgress(url, responseType, loadedname) {
        return new Promise((resolve, reject) => {
            if (currentXhr) {
                currentXhr.abort();
                loading(false);
            }

            const xhr = new XMLHttpRequest();
            currentXhr = xhr; // Store reference to the current XHR object

            loading(true, undefined, undefined, loadedname);

            xhr.open('GET', url, true);
            xhr.responseType = responseType;

            xhr.onprogress = (event) => {
                if (event.lengthComputable) {
                    loading(true, event.loaded, event.total, loadedname);
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    loading(false);
                    resolve(xhr.response);
                } else {
                    reject(`Failed to fetch: ${xhr.status}`);
                }
            };

            xhr.onerror = () => {
                loading(false);
                reject('Network error');
            };

            xhr.onabort = () => {
                loading(false);
                reject('Request aborted');
            };

            xhr.send();
        });
    }


    let servers = [
        "f890eashf08sh80fs",
        "80r39fdgfa8",
        "spot53451413",
    ]
    //https://glitch.com/edit/#!/remix/f890eashf08sh80fs
    function getRandomServer() {
        const randomIndex = Math.floor(Math.random() * servers.length);
        return servers[randomIndex];
    }
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function openDatabase() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('audioCacheDB', 1);

            request.onupgradeneeded = event => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('audioCache')) {
                    db.createObjectStore('audioCache', { keyPath: 'id' });
                }
            };

            request.onsuccess = event => {
                resolve(event.target.result);
            };

            request.onerror = event => {
                reject(event.target.error);
            };
        });
    }

    function storeAudioInDB(YoutubeID, mp3Blob) {
        return openDatabase().then(db => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['audioCache'], 'readwrite');
                const store = transaction.objectStore('audioCache');
                const request = store.put({ id: YoutubeID, audioBlob: mp3Blob });

                request.onsuccess = () => {
                    resolve();
                };

                request.onerror = event => {
                    reject(event.target.error);
                };
            });
        });
    }

    function getAudioFromDB(YoutubeID) {
        return openDatabase().then(db => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['audioCache'], 'readonly');
                const store = transaction.objectStore('audioCache');
                const request = store.get(YoutubeID);

                request.onsuccess = event => {
                    resolve(event.target.result);
                };

                request.onerror = event => {
                    reject(event.target.error);
                };
            });
        });
    }

    async function downloadaudio(YoutubeID, name) {
        const cachedAudio = await getAudioFromDB(YoutubeID);
        
        if (cachedAudio) {
            const blobUrl = URL.createObjectURL(cachedAudio.audioBlob);
            return blobUrl;
        } else {
            const arrayBuffer = await fetchWithProgress(`https://${getRandomServer()}.glitch.me/stream?ytid=${YoutubeID}`, "arraybuffer", name);
            const mp3Blob = new Blob([arrayBuffer], { type: 'audio/mp3' });
            await storeAudioInDB(YoutubeID, mp3Blob);
            const blobUrl = URL.createObjectURL(mp3Blob);
            return blobUrl;
        }
    }


    let playlist = localStorage.getItem("playlist")
    if (!playlist) {
        playlist = []
    } else {
        playlist = JSON.parse(playlist)
    }

    let playing = 0


    async function pingallservers() {
        while (true) {
            for (const i of servers) {
            fetch("https://" + i + ".glitch.me/lol")
            }
            await delay(250000)
        }
        

    }
    pingallservers()


        const audioElement = document.getElementById("audioPlayer");

        audioElement.addEventListener('ended', () => {
            playing += 1;
            if (playing >= playlist.length) {
                playing = 0;
            }
            playNextSong();
        });

        async function playNextSong() {
            audioElement.pause();
            document.getElementById("audioSource").src = "";
            audioElement.load()
            const song = playlist[playing];
            if (!song) {
                document.getElementById("songname").textContent = "";
                document.getElementById("rappername").textContent = "";
                document.getElementById("fgersi0sefdjhi").src = "";
                return
            }

            document.getElementById("songname").textContent = atob(song[0]);
            document.getElementById("rappername").textContent = atob(song[3]);
            document.getElementById("fgersi0sefdjhi").src = `https://i.ytimg.com/vi/${atob(song[1])}/hq720.jpg`;

            
            const audiourl = await downloadaudio(atob(song[1]), atob(song[0]))
            document.getElementById("audioSource").src = audiourl;

            audioElement.load();
            audioElement.play();
        }

        playNextSong();
    

    function previousSong() {
        playing -= 1;
        if (playing < 0) {
            playing = playlist.length - 1;
        }
        playNextSong();
    }

    function nextSong() {
        playing += 1;
        if (playing >= playlist.length) {
            playing = 0;
        }
        playNextSong();
    }


    async function addtoplaylist(songname, youtubeid, length, artist) {
        const isAlreadyInPlaylist = playlist.some(item => item[1] === youtubeid);

        if (!isAlreadyInPlaylist) {
            playlist.push([songname, youtubeid, length, artist]);
            localStorage.setItem("playlist", JSON.stringify(playlist));
            alert(`Song ${atob(songname)} added to the playlist.`);
        } else {
            alert(`Song ${atob(songname)} is already in the playlist.`);
        }
    }

    async function preview(songname, youtubeid, length, artist) {
        audioElement.pause();
        document.getElementById("audioSource").src = "";
        audioElement.load()
        document.getElementById("songname").textContent = atob(songname);
        document.getElementById("rappername").textContent = atob(artist);
        document.getElementById("fgersi0sefdjhi").src = `https://i.ytimg.com/vi/${atob(youtubeid)}/hq720.jpg`;
        const audiourl = await downloadaudio(atob(youtubeid))
        document.getElementById("audioSource").src = audiourl;
        audioElement.load();
        audioElement.play();
    }

    async function delsong(songid) {
        playlist.splice(songid, 1);
        localStorage.setItem("playlist", JSON.stringify(playlist));
        renderplaylist()
    }

    async function jmp(songid) {
        playing = parseInt(songid);
        if (playing >= playlist.length) {
            playing = 0;
        }
        if (playing < 0) {
            playing = playlist.length - 1;
        }
        playNextSong();
    }



    async function renderplaylist() {
                 document.getElementById("playlist").innerHTML = ""
        let p = 0
        for (const i of playlist) {
            let v = `<div class="playlisti" onclick="jmp('${p}')">
                <div class="crop-container">
                    <img src="https://i.ytimg.com/vi/${atob(i[1])}/hq720.jpg" alt="Image">
                    <img src="play.svg" class="playbtn">
                </div> 
                <div class="listi">
                    <h4>${atob(i[0])}</h4>
                    <h6>${atob(i[3])}</h6>
                </div>

                <button class="removefromplaylist" onclick="delsong('${p}')"><i class="material-icons">delete</i></button>
            </div>`
            document.getElementById("playlist").innerHTML += v
            p += 1
         }
    }
    renderplaylist()
    document.getElementById("homeb").onclick = async function() {
        document.getElementById("home").style.display = ""
         document.getElementById("searchcontent").style.display = "none"
         renderplaylist()
    }


    document.getElementById("searchb").onclick = async function() {
                document.getElementById("home").style.display = "none"
     document.getElementById("searchcontent").style.display = ""

        const query = prompt("Enter a search: ")
        document.getElementById("searchcontent").innerHTML = `<p>Loading results for "${query}"</p>`
        const vids = await fetchWithProgress(`https://${getRandomServer()}.glitch.me/search?query=${query}`, "json", `Search "${query}"`)
        console.log(vids)
        document.getElementById("searchcontent").innerHTML = ``

        document.getElementById("searchcontent").innerHTML += `Results for "${query}"`
        for (const i of vids) {
            try {
                const vi = `<div class="playlisti" onclick="preview('${btoa(i[0])}', '${btoa(i[2])}', '${btoa(i[3])}' , '${btoa(i[1])}')">
                <div class="crop-container">
                    <img src="https://i.ytimg.com/vi/${i[2]}/hq720.jpg" alt="Image">
                    <img src="play.svg" class="playbtn">
                </div> 
                <div class="listi">
                    <h4>${i[0]}</h4>
                    <h6>${i[1]}</h6>
                </div>

                <button class="addtoplaylist" onclick="addtoplaylist('${btoa(i[0])}', '${btoa(i[2])}', '${btoa(i[3])}' , '${btoa(i[1])}')"><i class="material-icons">add</i></button>
            </div>`

                document.getElementById("searchcontent").innerHTML += vi

            } catch(err) {
                console.log(err)
            }

            
        }

        if (vids.len == 0) {
            document.getElementById("searchcontent").innerHTML += "<h1>no results found you fucking bitch</h1>"
        }

    }

</script>
